{% extends "form_generico.html" %}
{% load static %}

{% block form %}
<!-- crear_servicio.html -->
<form method="post" id="servicio-form">
    {% csrf_token %}
    
    <!-- Información básica del servicio -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-car me-2"></i>Información del Vehículo</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.id_vehiculo.label_tag }}
                        {{ form.id_vehiculo }}
                        {% if form.id_vehiculo.errors %}
                            <div class="text-danger">
                                {{ form.id_vehiculo.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen del carrito -->
    <div class="card mb-4" id="resumen-carrito" style="display: none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Resumen del Servicio</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Repuestos:</strong> <span id="total-repuestos">0</span>
                </div>
                <div class="col-md-3">
                    <strong>Mantenimientos:</strong> <span id="total-mantenimientos">0</span>
                </div>
                <div class="col-md-3">
                    <strong>Insumos:</strong> <span id="total-insumos">0</span>
                </div>
                <div class="col-md-3">
                    <strong>Total:</strong> $<span id="total-servicio">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Repuestos (tipo carrito) -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Repuestos</h5>
            <button type="button" class="btn btn-light btn-sm" onclick="addMore('repuestos')">
                <i class="fas fa-plus me-1"></i>Agregar Repuesto
            </button>
        </div>
        <div class="card-body">
            {{ repuesto_formset.management_form }}
            <div id="repuestos-formset">
                {% for form in repuesto_formset %}
                <div class="repuesto-form row mb-3 border-bottom pb-3">
                    {{ form.id }}
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.id_repuesto.label_tag }}
                            {{ form.id_repuesto }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.cantidad.label_tag }}
                            {{ form.cantidad }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.precio_unitario.label_tag }}
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_unitario }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Subtotal</label>
                            <input type="text" class="form-control subtotal-repuesto" readonly value="$0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeForm(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tipos de Mantenimiento -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Tipos de Mantenimiento</h5>
            <button type="button" class="btn btn-light btn-sm" onclick="addMore('mantenimientos')">
                <i class="fas fa-plus me-1"></i>Agregar Mantenimiento
            </button>
        </div>
        <div class="card-body">
            {{ mantenimiento_formset.management_form }}
            <div id="mantenimientos-formset">
                {% for form in mantenimiento_formset %}
                <div class="mantenimiento-form row mb-3 border-bottom pb-3">
                    {{ form.id }}
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.id_tipo_mantenimiento.label_tag }}
                            {{ form.id_tipo_mantenimiento }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.cantidad.label_tag }}
                            {{ form.cantidad }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.precio_unitario.label_tag }}
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_unitario }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Subtotal</label>
                            <input type="text" class="form-control subtotal-mantenimiento" readonly value="$0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeForm(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Insumos -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Insumos</h5>
            <button type="button" class="btn btn-light btn-sm" onclick="addMore('insumos')">
                <i class="fas fa-plus me-1"></i>Agregar Insumo
            </button>
        </div>
        <div class="card-body">
            {{ insumo_formset.management_form }}
            <div id="insumos-formset">
                {% for form in insumo_formset %}
                <div class="insumo-form row mb-3 border-bottom pb-3">
                    {{ form.id }}
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.id_insumos.label_tag }}
                            {{ form.id_insumos }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.cantidad.label_tag }}
                            {{ form.cantidad }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.precio_unitario.label_tag }}
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.precio_unitario }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Subtotal</label>
                            <input type="text" class="form-control subtotal-insumo" readonly value="$0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeForm(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between">
        <a href="{% url 'apy:lista_servicios' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Guardar Servicio
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let repuestoIndex = {{ repuesto_formset.total_form_count }};
let mantenimientoIndex = {{ mantenimiento_formset.total_form_count }};
let insumoIndex = {{ insumo_formset.total_form_count }};

function updateTotals() {
    let totalRepuestos = 0;
    let totalMantenimientos = 0;
    let totalInsumos = 0;
    
    // Calcular subtotales de repuestos
    document.querySelectorAll('.repuesto-form').forEach(form => {
        const cantidad = parseFloat(form.querySelector('[name*="cantidad"]').value) || 0;
        const precio = parseFloat(form.querySelector('[name*="precio_unitario"]').value) || 0;
        const subtotal = cantidad * precio;
        totalRepuestos += subtotal;
        form.querySelector('.subtotal-repuesto').value = `$${subtotal.toLocaleString()}`;
    });
    
    // Calcular subtotales de mantenimientos
    document.querySelectorAll('.mantenimiento-form').forEach(form => {
        const cantidad = parseFloat(form.querySelector('[name*="cantidad"]').value) || 0;
        const precio = parseFloat(form.querySelector('[name*="precio_unitario"]').value) || 0;
        const subtotal = cantidad * precio;
        totalMantenimientos += subtotal;
        form.querySelector('.subtotal-mantenimiento').value = `$${subtotal.toLocaleString()}`;
    });
    
    // Calcular subtotales de insumos
    document.querySelectorAll('.insumo-form').forEach(form => {
        const cantidad = parseFloat(form.querySelector('[name*="cantidad"]').value) || 0;
        const precio = parseFloat(form.querySelector('[name*="precio_unitario"]').value) || 0;
        const subtotal = cantidad * precio;
        totalInsumos += subtotal;
        form.querySelector('.subtotal-insumo').value = `$${subtotal.toLocaleString()}`;
    });
    
    const totalServicio = totalRepuestos + totalMantenimientos + totalInsumos;
    
    // Actualizar resumen
    document.getElementById('total-repuestos').textContent = totalRepuestos.toLocaleString();
    document.getElementById('total-mantenimientos').textContent = totalMantenimientos.toLocaleString();
    document.getElementById('total-insumos').textContent = totalInsumos.toLocaleString();
    document.getElementById('total-servicio').textContent = totalServicio.toLocaleString();
    
    // Mostrar/ocultar resumen
    const resumenCarrito = document.getElementById('resumen-carrito');
    if (totalServicio > 0) {
        resumenCarrito.style.display = 'block';
    } else {
        resumenCarrito.style.display = 'none';
    }
}

function addMore(type) {
    const formsetDiv = document.getElementById(`${type}-formset`);
    const totalForms = document.getElementById(`id_${type}-TOTAL_FORMS`);
    const emptyForm = document.getElementById(`empty-${type}-form`).innerHTML;
    
    const newForm = emptyForm.replace(/__prefix__/g, eval(`${type}Index`));
    formsetDiv.insertAdjacentHTML('beforeend', newForm);
    
    eval(`${type}Index++`);
    totalForms.value = eval(`${type}Index`);
    
    // Agregar event listeners a los nuevos campos
    const newFormElement = formsetDiv.lastElementChild;
    newFormElement.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateTotals);
    });
    
    updateTotals();
}

function removeForm(button) {
    const form = button.closest('.row');
    const deleteCheckbox = form.querySelector('input[type="checkbox"][name*="DELETE"]');
    
    if (deleteCheckbox) {
        // Si es un formulario existente, marcar para eliminar y ocultar
        deleteCheckbox.checked = true;
        form.style.display = 'none';
    } else {
        // Si es un formulario nuevo, eliminar directamente
        form.remove();
        updateTotals();
    }
}

// Inicializar event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', updateTotals);
    });
    updateTotals();
});
</script>

<!-- Templates para nuevos formularios vacíos -->
<div id="empty-repuestos-form" style="display: none;">
    <div class="repuesto-form row mb-3 border-bottom pb-3">
        <div class="col-md-4">
            <div class="form-group">
                <label for="id_repuestos-__prefix__-id_repuesto" class="form-label">Repuesto</label>
                <select name="repuestos-__prefix__-id_repuesto" class="form-control" id="id_repuestos-__prefix__-id_repuesto">
                    <option value="">Seleccione un repuesto</option>
                    {% for repuesto in repuesto_formset.empty_form.id_repuesto.field.queryset %}
                        <option value="{{ repuesto.pk }}">{{ repuesto.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="id_repuestos-__prefix__-cantidad" class="form-label">Cantidad</label>
                <input type="number" name="repuestos-__prefix__-cantidad" class="form-control" id="id_repuestos-__prefix__-cantidad" min="1" value="1">
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="id_repuestos-__prefix__-precio_unitario" class="form-label">Precio unitario</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" name="repuestos-__prefix__-precio_unitario" class="form-control" id="id_repuestos-__prefix__-precio_unitario" step="0.01" min="0">
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label class="form-label">Subtotal</label>
                <input type="text" class="form-control subtotal-repuesto" readonly value="$0">
            </div>
        </div>
        <div class="col-md-1">
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeForm(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Templates similares para mantenimientos e insumos -->
<div id="empty-mantenimientos-form" style="display: none;">
    <!-- Similar estructura al de repuestos pero para mantenimientos -->
</div>

<div id="empty-insumos-form" style="display: none;">
    <!-- Similar estructura al de repuestos pero para insumos -->
</div>
{% endblock %}