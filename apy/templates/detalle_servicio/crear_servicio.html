{% extends "generic_listar.html" %}
{% load static %}

{% block title %}Crear Servicio{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-plus me-2"></i>Crear Nuevo Servicio
        </h1>
        <a href="/apy/servicios/" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a la Lista
        </a>
    </div>



    <form method="post" id="servicio-form">
        {% csrf_token %}
        
        <!-- Informaci√≥n del Veh√≠culo -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0"><i class="fas fa-car me-2"></i>Informaci√≥n del Veh√≠culo</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.id_vehiculo.label_tag }}
                            {{ form.id_vehiculo }}
                            {% if form.id_vehiculo.errors %}
                                <div class="text-danger">
                                    {{ form.id_vehiculo.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Repuestos -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Repuestos</h5>
                <button type="button" class="btn btn-light btn-sm" id="add-repuesto">
                    <i class="fas fa-plus me-1"></i>Agregar Repuesto
                </button>
            </div>
            <div class="card-body">
                {{ repuesto_formset.management_form }}
                <div id="repuestos-formset">
                    {% for form in repuesto_formset %}
                    <div class="repuesto-form row mb-3 border-bottom pb-3">
                        {{ form.id }}
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.id_repuesto.label_tag }}
                                {{ form.id_repuesto }}
                                {% if form.id_repuesto.errors %}
                                    <div class="text-danger small">
                                        {{ form.id_repuesto.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                {{ form.cantidad.label_tag }}
                                {{ form.cantidad }}
                                {% if form.cantidad.errors %}
                                    <div class="text-danger small">
                                        {{ form.cantidad.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form.precio_unitario.label_tag }}
                                {{ form.precio_unitario }}
                                {% if form.precio_unitario.errors %}
                                    <div class="text-danger small">
                                        {{ form.precio_unitario.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control subtotal-repuesto" readonly value="$0.00">
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm remove-form" {% if forloop.first and repuesto_formset.total_form_count == 1 %}disabled{% endif %}>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-end mt-3">
                    <strong>Total Repuestos: <span id="total-repuestos">$0.00</span></strong>
                </div>
            </div>
        </div>

        <!-- Tipos de Mantenimiento -->
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Tipos de Mantenimiento</h5>
                <button type="button" class="btn btn-light btn-sm" id="add-mantenimiento">
                    <i class="fas fa-plus me-1"></i>Agregar Mantenimiento
                </button>
            </div>
            <div class="card-body">
                {{ mantenimiento_formset.management_form }}
                <div id="mantenimientos-formset">
                    {% for form in mantenimiento_formset %}
                    <div class="mantenimiento-form row mb-3 border-bottom pb-3">
                        {{ form.id }}
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.id_tipo_mantenimiento.label_tag }}
                                {{ form.id_tipo_mantenimiento }}
                                {% if form.id_tipo_mantenimiento.errors %}
                                    <div class="text-danger small">
                                        {{ form.id_tipo_mantenimiento.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                {{ form.cantidad.label_tag }}
                                {{ form.cantidad }}
                                {% if form.cantidad.errors %}
                                    <div class="text-danger small">
                                        {{ form.cantidad.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form.precio_unitario.label_tag }}
                                {{ form.precio_unitario }}
                                {% if form.precio_unitario.errors %}
                                    <div class="text-danger small">
                                        {{ form.precio_unitario.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control subtotal-mantenimiento" readonly value="$0.00">
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm remove-form" {% if forloop.first and mantenimiento_formset.total_form_count == 1 %}disabled{% endif %}>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-end mt-3">
                    <strong>Total Mantenimientos: <span id="total-mantenimientos">$0.00</span></strong>
                </div>
            </div>
        </div>

        <!-- Insumos -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Insumos</h5>
                <button type="button" class="btn btn-light btn-sm" id="add-insumo">
                    <i class="fas fa-plus me-1"></i>Agregar Insumo
                </button>
            </div>
            <div class="card-body">
                {{ insumo_formset.management_form }}
                <div id="insumos-formset">
                    {% for form in insumo_formset %}
                    <div class="insumo-form row mb-3 border-bottom pb-3">
                        {{ form.id }}
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.id_insumos.label_tag }}
                                {{ form.id_insumos }}
                                {% if form.id_insumos.errors %}
                                    <div class="text-danger small">
                                        {{ form.id_insumos.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                {{ form.cantidad.label_tag }}
                                {{ form.cantidad }}
                                {% if form.cantidad.errors %}
                                    <div class="text-danger small">
                                        {{ form.cantidad.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form.precio_unitario.label_tag }}
                                {{ form.precio_unitario }}
                                {% if form.precio_unitario.errors %}
                                    <div class="text-danger small">
                                        {{ form.precio_unitario.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control subtotal-insumo" readonly value="$0.00">
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm remove-form" {% if forloop.first and insumo_formset.total_form_count == 1 %}disabled{% endif %}>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-end mt-3">
                    <strong>Total Insumos: <span id="total-insumos">$0.00</span></strong>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <a href="/apy/servicios/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Servicio
            </button>
        </div>
    </form>
</div>

<!-- ‚úÖ JAVASCRIPT INLINE - FUNCIONA CON BOOTSTRAP 5 -->
<script>
// DEBUG: Verificar que el script se ejecuta
console.log('‚úÖ Script de servicios CARGADO - Bootstrap 5');

// Contadores para los formsets
let repuestoIndex = {{ repuesto_formset.total_form_count }};
let mantenimientoIndex = {{ mantenimiento_formset.total_form_count }};
let insumoIndex = {{ insumo_formset.total_form_count }};

console.log('√çndices iniciales:', { repuestoIndex, mantenimientoIndex, insumoIndex });

// Templates para nuevos formularios
const repuestoTemplate = `
<div class="repuesto-form row mb-3 border-bottom pb-3">
    <div class="col-md-4">
        <div class="mb-3">
            <label class="form-label">Repuesto</label>
            <select name="repuestos-__prefix__-id_repuesto" class="form-control select-repuesto">
                <option value="">Seleccione un repuesto</option>
                {% for repuesto in repuestos %}
                    <option value="{{ repuesto.pk }}" data-precio="{{ repuesto.precio|default:0 }}">
                        {{ repuesto.nombre }} - ${{ repuesto.precio|default:0 }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" name="repuestos-__prefix__-cantidad" class="form-control cantidad-repuesto" min="1" value="1" step="1">
        </div>
    </div>
    <div class="col-md-3">
        <div class="mb-3">
            <label class="form-label">Precio unitario</label>
            <input type="number" name="repuestos-__prefix__-precio_unitario" class="form-control precio-repuesto" step="0.01" min="0" value="0">
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Subtotal</label>
            <input type="text" class="form-control subtotal-repuesto" readonly value="$0.00">
        </div>
    </div>
    <div class="col-md-1">
        <div class="mb-3">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-danger btn-sm remove-form">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>`;

const mantenimientoTemplate = `
<div class="mantenimiento-form row mb-3 border-bottom pb-3">
    <div class="col-md-4">
        <div class="mb-3">
            <label class="form-label">Tipo de Mantenimiento</label>
            <select name="mantenimientos-__prefix__-id_tipo_mantenimiento" class="form-control select-mantenimiento">
                <option value="">Seleccione un tipo</option>
                {% for tipo in tipos_mantenimiento %}
                    <option value="{{ tipo.pk }}" data-precio="{{ tipo.precio|default:0 }}">
                        {{ tipo.nombre }} - ${{ tipo.precio|default:0 }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" name="mantenimientos-__prefix__-cantidad" class="form-control cantidad-mantenimiento" min="1" value="1" step="1">
        </div>
    </div>
    <div class="col-md-3">
        <div class="mb-3">
            <label class="form-label">Precio unitario</label>
            <input type="number" name="mantenimientos-__prefix__-precio_unitario" class="form-control precio-mantenimiento" step="0.01" min="0" value="0">
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Subtotal</label>
            <input type="text" class="form-control subtotal-mantenimiento" readonly value="$0.00">
        </div>
    </div>
    <div class="col-md-1">
        <div class="mb-3">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-danger btn-sm remove-form">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>`;

const insumoTemplate = `
<div class="insumo-form row mb-3 border-bottom pb-3">
    <div class="col-md-4">
        <div class="mb-3">
            <label class="form-label">Insumo</label>
            <select name="insumos-__prefix__-id_insumos" class="form-control select-insumo">
                <option value="">Seleccione un insumo</option>
                {% for insumo in insumos %}
                    <option value="{{ insumo.pk }}" data-precio="{{ insumo.costo|default:0 }}">
                        {{ insumo.id_marca.nombre }} - ${{ insumo.costo|default:0 }} ({{ insumo.cantidad }})
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" name="insumos-__prefix__-cantidad" class="form-control cantidad-insumo" min="1" value="1" step="1">
        </div>
    </div>
    <div class="col-md-3">
        <div class="mb-3">
            <label class="form-label">Precio unitario</label>
            <input type="number" name="insumos-__prefix__-precio_unitario" class="form-control precio-insumo" step="0.01" min="0" value="0">
        </div>
    </div>
    <div class="col-md-2">
        <div class="mb-3">
            <label class="form-label">Subtotal</label>
            <input type="text" class="form-control subtotal-insumo" readonly value="$0.00">
        </div>
    </div>
    <div class="col-md-1">
        <div class="mb-3">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-danger btn-sm remove-form">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>`;

// Funci√≥n para agregar nuevo formulario
function addForm(type) {
    console.log('üü° Agregando formulario:', type);
    
    const formsetDiv = document.getElementById(`${type}-formset`);
    const totalForms = document.getElementById(`id_${type}-TOTAL_FORMS`);
    
    if (!formsetDiv || !totalForms) {
        console.error('‚ùå Elementos no encontrados');
        return;
    }
    
    let template, index;
    
    if (type === 'repuestos') {
        template = repuestoTemplate;
        index = repuestoIndex;
        repuestoIndex++;
    } else if (type === 'mantenimientos') {
        template = mantenimientoTemplate;
        index = mantenimientoIndex;
        mantenimientoIndex++;
    } else if (type === 'insumos') {
        template = insumoTemplate;
        index = insumoIndex;
        insumoIndex++;
    }
    
    const newForm = template.replace(/__prefix__/g, index);
    formsetDiv.insertAdjacentHTML('beforeend', newForm);
    totalForms.value = parseInt(totalForms.value) + 1;
    
    console.log('‚úÖ Formulario agregado. Total:', totalForms.value);
}

// Funci√≥n para eliminar formulario
function removeForm(button) {
    console.log('Eliminando formulario');
    const form = button.closest('.row');
    if (form) {
        form.remove();
    }
}

// INICIALIZACI√ìN cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM completamente cargado - Bootstrap 5');
    
    // Botones agregar
    document.getElementById('add-repuesto').addEventListener('click', function() {
        console.log('üéØ Click en agregar repuesto');
        addForm('repuestos');
    });
    
    document.getElementById('add-mantenimiento').addEventListener('click', function() {
        console.log('üéØ Click en agregar mantenimiento');
        addForm('mantenimientos');
    });
    
    document.getElementById('add-insumo').addEventListener('click', function() {
        console.log('üéØ Click en agregar insumo');
        addForm('insumos');
    });
    
    // Delegaci√≥n de eventos para botones eliminar
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-form') || e.target.closest('.remove-form')) {
            console.log('üéØ Click en eliminar formulario');
            const button = e.target.classList.contains('remove-form') ? e.target : e.target.closest('.remove-form');
            removeForm(button);
        }
    });
    
    console.log('‚úÖ Todos los event listeners configurados');
});
</script>
{% endblock %}