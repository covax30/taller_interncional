{% load widget_tweaks %}
{% block form %}

    <div id="msg-cliente"></div>  {# Aquí se mostrarán los mensajes #}

    <form id="clienteForm" method="post" action="{% url 'apy:cliente_modal_crear' %}">
        {% csrf_token %}
    {% for field in form.visible_fields %}
    <div class="form-group mb-3">
        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
        {{ field|add_class:'form-control'|attr:'autocomplete:off' }}

        {% if field.errors %}
            <div class="invalid-feedback d-block">
                {% for error in field.errors %}
                    <small>{{ error }}</small><br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {% endfor %}
{% endblock %}

    {% block Cancelar %}
    <button type="button" id="btnGuardarCliente" class="btn btn-primary btn-flat">
        <i class="fas fa-save"></i> Agregar
    </button>
    <button type="button" id="btnCancelarCliente" 
            class="btn btn-default btn-flat float-right" 
            data-bs-dismiss="modal">
        <i class="fas fa-times"></i> Cancelar
    </button>
{% endblock %}



{% block extra_js %}
<script>
/* Delegación: captura clicks de botones que aparezcan dinámicamente */
$(document).on('click', '#btnGuardarCliente', function(e){
    e.preventDefault();
    const $btn = $(this);
    const $modal = $('#modal-id_cliente');
    const $form = $modal.find('form#clienteForm');

    if (!$form.length) {
        console.error('No se encontró el formulario #clienteForm dentro del modal.');
        return;
    }

    const url = $form.attr('action');
    const formData = new FormData($form[0]);

    $btn.prop('disabled', true).addClass('disabled').text('Guardando...');

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(data){
         if (data.success) {
        // Mostrar mensaje de éxito
        if (!$modal.find('#msg-cliente').length) {
            $modal.find('.modal-body').prepend('<div id="msg-cliente"></div>');
        }
        $modal.find('#msg-cliente').html('<div class="alert alert-success">' + data.message + '</div>');

        // Actualizar select en la página principal
        const $select = $('#id_id_cliente');
        const option = new Option(data.text, data.id, true, true);
        $select.append(option).val(data.id).trigger('change');

        // ✅ CERRAR EL MODAL INMEDIATAMENTE
        
         $modal.modal('hide');
         $('body').removeClass('modal-open');
         $('body').css('padding-right', '');
         $('.modal-backdrop').remove();
         $modal.removeClass('show');
         $modal.css('display', 'none');
        

    } else {
        // Manejar errores de validación
        if (data.html) {
            $modal.find('.modal-body').html(data.html);
        } else {
            if (!$modal.find('#msg-cliente').length) {
                $modal.find('.modal-body').prepend('<div id="msg-cliente"></div>');
            }
            $modal.find('#msg-cliente').html('<div class="alert alert-danger">' + data.message + '</div>');
        }
    }
},
        error: function(xhr, status, err) {
            if (!$modal.find('#msg-cliente').length) $modal.find('.modal-body').prepend('<div id="msg-cliente"></div>');
            $modal.find('#msg-cliente').html('<div class="alert alert-danger">Error en el servidor. Revisa consola.</div>');
            console.error('AJAX error:', status, err);
        },
        complete: function(){
            $btn.prop('disabled', false).removeClass('disabled').text('Agregar');
        }
    });
});

// Cuando el modal se cierre, limpiar el formulario
$('#modal-id_cliente').on('hidden.bs.modal', function () {
    const $form = $(this).find('form#clienteForm')[0];
    if ($form) {
        $form.reset(); // resetea todos los inputs
    }
    // limpiar mensajes de validación si los hubiera
    $(this).find('#msg-cliente').html('');
});
</script>

{% endblock %}
