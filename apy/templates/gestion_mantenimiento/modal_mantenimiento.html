{% load widget_tweaks %}
{% block form %}

    <div id="msg-mantenimiento"></div>  {# Aquí se mostrarán los mensajes #}

    <form id="mantenimientoForm" method="post" action="{% url 'apy:mantenimiento_modal_crear' %}">
        {% csrf_token %}

    <!-- Campo Empleado con botón para abrir modal -->
    <div class="form-group mb-3">
        <label for="{{ form.id_empleado_mantenimiento.id_for_label }}">Id Empleado:</label>
        <div class="input-group">
            {{ form.id_empleado|add_class:'form-control'|attr:'autocomplete:off' }}
            <div class="input-group-append">
            </div>
        </div>
        {% if form.id_empleado_mantenimiento.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.id_empleado_mantenimiento.errors %}
                    <small>{{ error }}</small><br>
                {% endfor %}
            </div>
        {% endif %}
    </div>    

    <!-- Campo Vehículo con botón para abrir modal -->
    <div class="form-group mb-3">
        <label for="{{ form.id_vehiculo.id_for_label }}">Id Vehículo:</label>
        <div class="input-group">
            {{ form.id_vehiculo|add_class:'form-control'|attr:'autocomplete:off' }}
            <div class="input-group-append">
                <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#modal-id_vehiculo" title="Agregar nuevo vehículo">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        {% if form.id_vehiculo.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.id_vehiculo.errors %}
                    <small>{{ error }}</small><br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Campo Tipo Mantenimiento con botón para abrir modal -->
    <div class="form-group mb-3">
        <label for="{{ form.id_tipo_mantenimiento.id_for_label }}">Tipo Mantenimiento:</label>
        <div class="input-group">
            {{ form.id_tipo_mantenimiento|add_class:'form-control'|attr:'autocomplete:off' }}
            <div class="input-group-append">
                <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#modal-id_tipo_mantenimiento" title="Agregar nuevo tipo de mantenimiento">
                    <i class="fas fa-plus"></i>
                </button>
            </div>         
        </div>
        {% if form.id_tipo_mantenimiento.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.id_tipo_mantenimiento.errors %}
                    <small>{{ error }}</small><br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Renderiza el resto de los campos, excepto id_vehiculo -->
    {% for field in form.visible_fields %}
        {% if field.name != 'id_empleado' and field.name != 'id_vehiculo' and field.name != 'id_tipo_mantenimiento' %}
            <div class="form-group mb-3">
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                {{ field|add_class:'form-control'|attr:'autocomplete:off' }}
                {% if field.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in field.errors %}
                            <small>{{ error }}</small><br>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% endfor %}
</form>

{% endblock %}

{% block Cancelar %}
    <button type="button" id="btnGuardarMantenimiento" class="btn btn-primary btn-flat">
        <i class="fas fa-save"></i> Agregar
    </button>
{% endblock %}



{% block extra_js %}
<script>
/* ✅ Evita duplicar eventos (clave del arreglo) */
$(document).off('click', '#btnGuardarMantenimiento').on('click', '#btnGuardarMantenimiento', function(e) {
    e.preventDefault();

    const $btn = $(this);
    const $modal = $('#modal-id_mantenimiento');
    const $form = $modal.find('form#mantenimientoForm');

    if (!$form.length) {
        console.error('No se encontró el formulario #mantenimientoForm dentro del modal.');
        return;
    }

    const url = $form.attr('action');
    const formData = new FormData($form[0]);

    $btn.prop('disabled', true).addClass('disabled').text('Guardando...');

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(data) {
            if (data.success) {
                // Mensaje de éxito
                const $msg = $modal.find('#msg-mantenimiento');
                $msg.html('<div class="alert alert-success">' + data.message + '</div>');

                // Actualizar select en la página principal
                const $select = $('#id_id_mantenimiento');
                if ($select.find('option[value="' + data.id + '"]').length === 0) {
                    const option = new Option(data.text, data.id, true, true);
                    $select.append(option).val(data.id).trigger('change');
                } else {
                    $select.val(data.id).trigger('change');
                }

                // Cerrar el modal correctamente
                $modal.modal('hide');
                $modal.modal('hide');
                $('body').removeClass('modal-open');
                $('body').css('padding-right', '');
                $('.modal-backdrop').remove();
                $modal.removeClass('show');
                $modal.css('display', 'none');
            } else {
                if (data.html) {
                    $modal.find('.modal-body').html(data.html);
                } else {
                    $modal.find('#msg-mantenimiento').html('<div class="alert alert-danger">' + data.message + '</div>');
                }
            }
        },
        error: function(xhr, status, err) {
            const $msg = $modal.find('#msg-mantenimiento');
            $msg.html('<div class="alert alert-danger">Error en el servidor. Revisa consola.</div>');
            console.error('AJAX error:', status, err);
        },
        complete: function() {
            $btn.prop('disabled', false).removeClass('disabled').text('Agregar');
        }
    });
});

/* ✅ Limpiar el formulario y mensajes al cerrar */
$('#modal-id_mantenimiento').on('hidden.bs.modal', function() {
    const $form = $(this).find('form#mantenimientoForm')[0];
    if ($form) $form.reset();
    $(this).find('#msg-mantenimiento').html('');
});
</script>
{% endblock %}
